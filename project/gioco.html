<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Avventura Sci-Fi: La Luce di Eldoria</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background: #f9fafb;
    color: #222;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  #game-container {
    max-width: 600px;
    width: 100%;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    padding: 2rem 2.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.5s ease, transform 0.5s ease;
  }
  #game-container.visible {
    opacity: 1;
    transform: translateY(0);
  }
  h1, h2 {
    margin: 0 0 1rem 0;
    font-weight: 600;
    text-align: center;
    color: #111;
  }
  p {
    line-height: 1.5;
    margin-bottom: 1.5rem;
    font-size: 1rem;
  }
  ul {
    padding-left: 1.25rem;
    margin-bottom: 1.5rem;
  }
  button {
    background-color: #2563eb;
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    margin: 0.5rem 0;
    font-size: 1rem;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
    max-width: 320px;
    transition: background-color 0.3s ease;
    font-weight: 600;
  }
  button:hover, button:focus {
    background-color: #1e40af;
    outline: none;
  }
  #choices {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  @media (max-width: 480px) {
    #game-container {
      padding: 1.5rem 1.5rem;
    }
    button {
      font-size: 0.9rem;
      padding: 0.65rem 1.2rem;
    }
  }
</style>
</head>
<body>
<div id="game-container" aria-live="polite" aria-atomic="true">
  <!-- Content dynamically inserted here -->
</div>
<script>
(() => {
  "use strict";

  // Game state variables
  const state = {
    location: 'dawnmere',
    crystalLost: true,
    darkWardenDefeated: false,
    hasMagicalKey: false,
    hasCharm: false,
    hasSword: false,
    hasShield: false,
    wounded: false,
    rested: false,
    trapsSet: false,
    reputationKindness: false,
    reputationCourage: false,
    dispositionKnown: false,
    crystalPossessed: false,
    kingdomSaved: false,
    // Track path for endings or stats if needed
    pathSteps: 0,
  };

  // Sections data keyed by section number
  // Each section has:
  // - narrative: Italian text
  // - stateUpdate: function to update state on entering section
  // - choices: array of { text, nextSection, condition (optional) }
  // condition is a function returning boolean to show/hide choice
  // nextSection is number or string (for end states)
  // For plan-driven sections, we will follow the plan steps strictly

  // Because the plan is linear and short, we will implement the plan steps as forced progression
  // The plan steps:
  // 1) head-directly-to-whispering-forest hero dawnmere alcove dark-warden temple-of-echoes shield shield
  // 2) answer-honestly-to-spirit hero alcove alcove shield sword
  // 3) enter-temple hero alcove alcove dark-warden
  // 4) direct-confrontation hero alcove dark-warden
  // 5) claim-crystal-and-exit hero alcove alcove

  // We will map these to sections:
  // Section 1: Start (village dawnmere)
  // Section 3: Head directly to forest unprepared (but plan says alcove location, we adapt narrative)
  // Section 7: Answer honestly to spirit
  // Section 12: Enter temple
  // Section 15: Direct combat
  // Section 17: Claim crystal and exit (success)

  // We will adapt narrative to match plan locations (alcove used as forest/temple entrance)

  // For the sake of narrative flow and player interaction, we will show only the choices that match the plan path,
  // but still present them as buttons to proceed.

  // Sections narrative and choices in Italian:

  const sections = {
    1: {
      narrative: `<p>Il sole tramonta sul tranquillo villaggio di Dawnmere, proiettando lunghe ombre sulle strade di ciottoli. L'eroe, avvolto in un umile mantello da viaggiatore, si trova nella piazza del villaggio, il peso del destino del regno gravante sulle spalle. Si è diffusa la voce che il Cristallo di Luce è stato rubato, gettando Eldoria nella disperazione. I villaggi sussurrano della Foresta Sussurrante, dove si dice che uno spirito della foresta misterioso custodisca una chiave magica che può aprire il nascosto Tempio degli Echi — l'ultimo luogo conosciuto dove il Cristallo è stato visto. Ma lo spirito aiuta solo chi ritiene degno. Nei paraggi, la silhouette minacciosa del Guardiano Oscuro incombe, a guardia del tempio con magia oscura e ferocia. L'eroe deve scegliere con cura il proprio cammino per reclamare il Cristallo e salvare Eldoria.</p>
      <ul>
        <li>Posizione eroe: Villaggio di Dawnmere</li>
        <li>Cristallo di Luce: Perduto</li>
        <li>Guardiano Oscuro: A guardia del Tempio degli Echi</li>
        <li>L'eroe non possiede la chiave magica</li>
        <li>Lo spirito della foresta: Disposizione sconosciuta</li>
      </ul>`,
      choices: [
        { text: "Cerca la guida dell'anziana del villaggio", next: 2 },
        { text: "Dirigiti direttamente verso la Foresta Sussurrante", next: 3 },
        { text: "Visita il fabbro", next: 4 },
      ],
      onEnter: () => {
        // Reset state to initial
        state.location = 'dawnmere';
        state.crystalLost = true;
        state.darkWardenDefeated = false;
        state.hasMagicalKey = false;
        state.hasCharm = false;
        state.hasSword = false;
        state.hasShield = false;
        state.wounded = false;
        state.rested = false;
        state.trapsSet = false;
        state.reputationKindness = false;
        state.reputationCourage = false;
        state.dispositionKnown = false;
        state.crystalPossessed = false;
        state.kingdomSaved = false;
        state.pathSteps = 0;
      }
    },
    2: {
      narrative: `<p>La capanna dell'anziana scricchiola mentre entri, pervasa dal profumo di erbe e antichi tomi. L'anziana, una donna rugosa con occhi come ambra lucidata, ascolta attentamente. "Lo spirito della foresta mette alla prova il cuore," dice. "Per guadagnare la chiave, devi dimostrare il tuo valore. Alcuni dicono che la gentilezza apre le porte, altri il coraggio. Attento, la foresta sussurra verità che possono ingannare." Ti offre un semplice amuleto detto per proteggere i viaggiatori dalle illusioni. Con questa conoscenza e l'amuleto, ti senti meglio preparato ad affrontare le prove della foresta.</p>
      <ul>
        <li>Posizione eroe: Capanna dell'anziana</li>
        <li>L'eroe possiede l'amuleto di protezione</li>
        <li>Cristallo di Luce: Perduto</li>
        <li>Guardiano Oscuro: A guardia del tempio</li>
        <li>L'eroe non possiede la chiave magica</li>
      </ul>`,
      choices: [
        { text: "Entra nella Foresta Sussurrante con l'amuleto", next: 5 },
        { text: "Allenati con i villaggi", next: 6 },
      ],
      onEnter: () => {
        state.location = 'elder-hut';
        state.hasCharm = true;
        state.dispositionKnown = true;
      }
    },
    3: {
      narrative: `<p>La foresta ti accoglie con un silenzio inquietante, ombre che danzano tra gli alberi antichi. Senza guida né protezione, i sussurri si fanno più forti, distorcendo i tuoi pensieri. Improvvisamente, appare una figura spettrale — lo spirito della foresta. Ti fissa con occhi penetranti e chiede: "Perché dovrei concederti la chiave?" Il cuore ti batte forte; devi dimostrare il tuo valore ora o essere scacciato.</p>
      <ul>
        <li>Posizione eroe: Dentro la Foresta Sussurrante</li>
        <li>Nessun amuleto o preparazione</li>
        <li>Spirito della foresta presente</li>
        <li>Cristallo di Luce: Perduto</li>
        <li>Guardiano Oscuro: A guardia del tempio</li>
      </ul>`,
      choices: [
        { text: "Rispondi con onestà e umiltà", next: 7 },
        { text: "Prova a intimidire lo spirito", next: 8 },
      ],
      onEnter: () => {
        state.location = 'alcove'; // Using alcove as forest location per plan
        state.hasCharm = false;
        state.hasSword = false;
        state.hasShield = false;
        state.dispositionKnown = false;
        state.wounded = false;
      }
    },
    4: {
      narrative: `<p>Il clangore del martello sull'incudine risuona nella bottega del fabbro. Il fabbro, un uomo robusto con il volto segnato dalla fuliggine, annuisce approvando la tua determinazione e ti dota di una spada finemente lavorata e di uno scudo robusto. "Ti servirà più del coraggio per affrontare lo spirito della foresta e il Guardiano Oscuro," avverte. Armato e pronto, ti senti più sicuro ma ancora privo della chiave magica.</p>
      <ul>
        <li>Posizione eroe: Bottega del fabbro a Dawnmere</li>
        <li>L'eroe possiede spada e scudo</li>
        <li>Cristallo di Luce: Perduto</li>
        <li>Guardiano Oscuro: A guardia del tempio</li>
        <li>L'eroe non possiede la chiave magica</li>
      </ul>`,
      choices: [
        { text: "Avventurati nella Foresta Sussurrante", next: 5 },
        { text: "Cerca la guida dell'anziana prima di entrare", next: 2 },
      ],
      onEnter: () => {
        state.location = 'blacksmith';
        state.hasSword = true;
        state.hasShield = true;
      }
    },
    5: {
      narrative: `<p>Più in profondità nella foresta, l'aria si fa densa di magia. Lo spirito della foresta emerge dalle ombre, la sua forma muta come foglie al vento. Ti osserva in silenzio, percependo il tuo amuleto e la tua preparazione. "Molti cercano la chiave, ma pochi sono degni. Mostrami la vera natura del tuo cuore." Sei pronto a dimostrare il tuo valore.</p>
      <ul>
        <li>Posizione eroe: Foresta Sussurrante, davanti allo spirito</li>
        <li>L'eroe ha amuleto o armi o entrambi</li>
        <li>Spirito della foresta presente</li>
        <li>Cristallo di Luce: Perduto</li>
      </ul>`,
      choices: [
        { text: "Offri aiuto a una creatura ferita nei dintorni", next: 9 },
        { text: "Parla sinceramente della tua missione e delle tue paure", next: 10 },
        { text: "Prova a persuadere lo spirito con magia o forza", next: 8 },
      ],
      onEnter: () => {
        state.location = 'alcove'; // Using alcove as forest location
      }
    },
    6: {
      narrative: `<p>Passano giorni mentre aiuti i villaggi: portando legna a un anziano, calmando bambini spaventati e condividendo storie attorno al focolare. Il tuo cuore si rafforza, la tua determinazione si fa più chiara. L'anziana sorride, "Hai mostrato le virtù che lo spirito della foresta cerca. Ora puoi affrontarlo con un cuore puro."</p>
      <ul>
        <li>Posizione eroe: Villaggio di Dawnmere</li>
        <li>Reputazione eroe: Gentilezza e coraggio migliorati</li>
        <li>L'eroe possiede amuleto di protezione</li>
        <li>Cristallo di Luce: Perduto</li>
      </ul>`,
      choices: [
        { text: "Entra nella Foresta Sussurrante", next: 5 },
        { text: "Ritarda il viaggio per allenarti ancora", next: 11 },
      ],
      onEnter: () => {
        state.location = 'dawnmere';
        state.reputationKindness = true;
        state.reputationCourage = true;
        state.hasCharm = true;
      }
    },
    7: {
      narrative: `<p>Le tue parole tremano ma sono sincere. "Cerco il Cristallo non per gloria, ma per salvare il mio popolo." Lo spirito ti studia, poi sorride lievemente. "Il tuo cuore è sincero, ma la foresta è pericolosa. Prendi questa chiave, ma attento all'ira del Guardiano Oscuro." Ti porge una chiave luminosa. Improvvisamente, il sentiero verso il Tempio degli Echi si apre davanti a te.</p>
      <ul>
        <li>Posizione eroe: Foresta Sussurrante, davanti all'ingresso del tempio</li>
        <li>L'eroe possiede la chiave magica</li>
        <li>Cristallo di Luce: Perduto</li>
        <li>Guardiano Oscuro: A guardia del tempio</li>
      </ul>`,
      choices: [
        { text: "Entra nel Tempio degli Echi usando la chiave", next: 12 },
        { text: "Riposa prima di entrare nel tempio", next: 13 },
      ],
      onEnter: () => {
        state.location = 'alcove'; // temple entrance
        state.hasMagicalKey = true;
      }
    },
    8: {
      narrative: `<p>Alzi la tua arma o scagli la magia, ma lo spirito della foresta ride soltanto — un suono come vento tra i rami. "Sciocco mortale, la forza senza valore è vuota." Con un gesto della mano, vieni scacciato, inciampando verso il bordo della foresta, contuso e scoraggiato. La tua missione si fa più oscura.</p>
      <ul>
        <li>Posizione eroe: Bordi della Foresta Sussurrante</li>
        <li>Nessuna chiave</li>
        <li>Eroe ferito o scoraggiato</li>
        <li>Cristallo di Luce: Perduto</li>
      </ul>`,
      choices: [
        { text: "Riorganizzati e cerca la guida dell'anziana", next: 2 },
        { text: "Prova a entrare di nuovo nella foresta con umiltà", next: 5 },
      ],
      onEnter: () => {
        state.location = 'edge-forest';
        state.wounded = true;
      }
    },
    9: {
      narrative: `<p>Ti inginocchi accanto a una volpe ferita intrappolata. Con cura la liberi e curi le sue ferite con mani gentili. Lo spirito della foresta osserva in silenzio, poi annuisce approvando. "La gentilezza rivela la vera forza." Ti concede la chiave magica che brilla di luce antica.</p>
      <ul>
        <li>Posizione eroe: Foresta Sussurrante vicino all'ingresso del tempio</li>
        <li>L'eroe possiede la chiave magica</li>
        <li>Cristallo di Luce: Perduto</li>
        <li>Guardiano Oscuro: A guardia del tempio</li>
      </ul>`,
      choices: [
        { text: "Usa la chiave per entrare nel Tempio degli Echi", next: 12 },
        { text: "Perlustra il perimetro del tempio", next: 14 },
      ],
      onEnter: () => {
        state.location = 'alcove';
        state.hasMagicalKey = true;
      }
    },
    10: {
      narrative: `<p>Racconti la tua storia apertamente, voce ferma nonostante le paure. Gli occhi dello spirito si addolciscono. "Onestà e coraggio sono rari. Ti concedo la chiave, ma l'oscurità del tempio mette alla prova più delle lame." Ti porge la chiave magica. Il sentiero verso il Tempio degli Echi si apre davanti a te, velato d'ombre.</p>
      <ul>
        <li>Posizione eroe: Foresta Sussurrante davanti al tempio</li>
        <li>L'eroe possiede la chiave magica</li>
        <li>Cristallo di Luce: Perduto</li>
        <li>Guardiano Oscuro: A guardia del tempio</li>
      </ul>`,
      choices: [
        { text: "Entra nel tempio", next: 12 },
        { text: "Prepara trappole o difese all'interno del tempio", next: 14 },
      ],
      onEnter: () => {
        state.location = 'alcove';
        state.hasMagicalKey = true;
      }
    },
    11: {
      narrative: `<p>Il tempo passa mentre affini le tue virtù tra la tua gente. Ma le voci si fanno più cupe — il potere del Guardiano Oscuro cresce e la luce del Cristallo si affievolisce. Pur più forte nel cuore, il ritardo minaccia la tua occasione. L'anziana avverte, "Più aspetti, più difficile sarà il cammino."</p>
      <ul>
        <li>Posizione eroe: Villaggio di Dawnmere</li>
        <li>Reputazione eroe: Gentilezza e coraggio elevati</li>
        <li>Cristallo di Luce: Perduto</li>
        <li>Guardiano Oscuro: Sta aumentando il potere</li>
      </ul>`,
      choices: [
        { text: "Entra ora nella Foresta Sussurrante", next: 5 },
        { text: "Prepara le armi con il fabbro", next: 4 },
      ],
      onEnter: () => {
        state.location = 'dawnmere';
        state.reputationKindness = true;
        state.reputationCourage = true;
      }
    },
    12: {
      narrative: `<p>Il tempio si erge, antiche pietre vibrano di potere. La chiave magica pulsa, sbloccando porte immense. All'interno, le ombre si contorcono mentre appare il Guardiano Oscuro, avvolto nelle tenebre, occhi ardenti di malvagità. "Sciocco eroe," sghigna. "Il Cristallo è mio." Acciaio contro stregoneria, inizia la battaglia finale.</p>
      <ul>
        <li>Posizione eroe: Dentro il Tempio degli Echi</li>
        <li>L'eroe possiede la chiave magica</li>
        <li>Guardiano Oscuro presente</li>
        <li>Cristallo di Luce: Perduto</li>
      </ul>`,
      choices: [
        { text: "Affronta il Guardiano Oscuro in combattimento diretto", next: 15 },
        { text: "Usa l'ambiente per ottenere vantaggio", next: 14 },
      ],
      onEnter: () => {
        state.location = 'alcove';
      }
    },
    13: {
      narrative: `<p>Trovi un angolo tranquillo vicino all'ingresso del tempio, raccogliendo forza e concentrazione. L'amuleto di protezione brilla debolmente, allontanando le ombre striscianti. Mediti sul viaggio e rafforzi la mente per ciò che ti attende. Ma il tempo è fugace — il potere del Guardiano Oscuro cresce ad ogni momento.</p>
      <ul>
        <li>Posizione eroe: Nicchia all'ingresso del tempio</li>
        <li>Eroe riposato e concentrato</li>
        <li>L'eroe possiede la chiave magica</li>
        <li>Cristallo di Luce: Perduto</li>
      </ul>`,
      choices: [
        { text: "Entra ora nel tempio", next: 12 },
        { text: "Perlustra prima il perimetro del tempio", next: 14 },
      ],
      onEnter: () => {
        state.location = 'alcove';
        state.rested = true;
      }
    },
    14: {
      narrative: `<p>Con cautela, circumnavi le ombre del tempio, notando rune antiche e fessure nascoste. Trovi resti di vecchie trappole e posti dove nascondersi, preparando le tue insidie e pianificando un'imboscata. L'arroganza del Guardiano Oscuro potrebbe essere la sua rovina se giochi bene le tue carte.</p>
      <ul>
        <li>Posizione eroe: Perimetro del tempio</li>
        <li>L'eroe ha preparato trappole o punti strategici</li>
        <li>L'eroe possiede la chiave magica</li>
        <li>Cristallo di Luce: Perduto</li>
      </ul>`,
      choices: [
        { text: "Tendi un'imboscata al Guardiano Oscuro usando le trappole", next: 16 },
        { text: "Entra nel tempio per il confronto diretto", next: 15 },
      ],
      onEnter: () => {
        state.location = 'alcove';
        state.trapsSet = true;
      }
    },
    15: {
      narrative: `<p>Lo scontro di acciaio e magia oscura riempie le sale del tempio. Il Guardiano Oscuro colpisce con potenza devastante, ma il tuo allenamento e coraggio resistono. Dopo una battaglia feroce, vacilla, la sua aura oscura svanisce. Con un colpo finale, lo sconfiggi. Il Cristallo di Luce brilla su un piedistallo, la sua luce ristora la speranza in Eldoria.</p>
      <ul>
        <li>Posizione eroe: Interno del tempio</li>
        <li>Guardiano Oscuro sconfitto</li>
        <li>L'eroe possiede il Cristallo di Luce</li>
      </ul>`,
      choices: [
        { text: "Prendi il Cristallo ed esci dal tempio", next: 17 },
      ],
      onEnter: () => {
        state.location = 'alcove';
        state.darkWardenDefeated = true;
        state.crystalPossessed = true;
      }
    },
    16: {
      narrative: `<p>Le tue trappole scattano perfettamente; il Guardiano Oscuro è colto di sorpresa, inciampando tra lacci e vincoli magici. Colto il momento, colpisci con tutta la tua forza. Il potere del Guardiano svanisce sotto il tuo assalto incessante. Infine, crolla sconfitto. Il Cristallo di Luce splende luminoso, in attesa della tua presa.</p>
      <ul>
        <li>Posizione eroe: Interno del tempio</li>
        <li>Guardiano Oscuro sconfitto</li>
        <li>L'eroe possiede il Cristallo di Luce</li>
      </ul>`,
      choices: [
        { text: "Prendi il Cristallo ed esci dal tempio", next: 17 },
      ],
      onEnter: () => {
        state.location = 'alcove';
        state.darkWardenDefeated = true;
        state.crystalPossessed = true;
      }
    },
    17: {
      narrative: `<p>Con il Cristallo di Luce al sicuro, ascendi dal Tempio degli Echi mentre l'alba sorge su Eldoria. Le ombre del regno si ritirano, sostituite da una speranza radiosa. I villaggi di Dawnmere acclamano il tuo ritorno, e l'anziana sorride con saggezza. Il tuo coraggio, gentilezza e saggezza hanno riportato pace e luce nel regno.</p>
      <ul>
        <li>Posizione eroe: Villaggio di Dawnmere</li>
        <li>L'eroe possiede il Cristallo di Luce</li>
        <li>Guardiano Oscuro sconfitto</li>
        <li>Regno di Eldoria salvato</li>
      </ul>`,
      choices: [
        { text: "Celebra la vittoria", next: "end-success" },
      ],
      onEnter: () => {
        state.location = 'dawnmere';
        state.kingdomSaved = true;
      }
    },
    18: {
      narrative: `<p>Senza la chiave magica, le porte del tempio restano sigillate. I tentativi di forzarle risvegliano antiche maledizioni, prosciugando le tue forze. Oppure il potere del Guardiano Oscuro ti sopraffà in battaglia. Le tenebre calano su Eldoria mentre la speranza svanisce, il Cristallo di Luce perso per sempre. Il destino del regno resta incerto, e le ombre si fanno più profonde.</p>`,
      choices: [
        { text: "Accetta la sconfitta", next: "end-failure" },
      ],
      onEnter: () => {
        // Failure state
      }
    }
  };

  // Plan steps mapped to sections for forced progression:
  // We will override choices to only allow the planned path.

  // Plan steps sequence:
  // 1) head-directly-to-whispering-forest -> Section 3
  // 2) answer-honestly-to-spirit -> Section 7
  // 3) enter-temple -> Section 12
  // 4) direct-confrontation -> Section 15
  // 5) claim-crystal-and-exit -> Section 17

  // We will implement a planStepIndex to track progress through plan steps.

  const planSequence = [3,7,12,15,17];

  let planStepIndex = -1;

  // DOM references
  const container = document.getElementById('game-container');

  // Utility: fade out content, then fade in new content
  function fadeOutIn(newContentHtml) {
    container.classList.remove('visible');
    setTimeout(() => {
      container.innerHTML = newContentHtml;
      container.classList.add('visible');
    }, 400);
  }

  // Render start page with story summary and start button
  function renderStartPage() {
    planStepIndex = -1;
    const summary = `<h1>La Luce di Eldoria</h1>
    <p>Il Regno di Eldoria è sull'orlo del collasso dopo il furto del Cristallo di Luce. Tu, l'eroe, devi recuperarlo attraversando la Foresta Sussurrante, trovando il nascosto Tempio degli Echi e sconfiggendo il Guardiano Oscuro. Scegli saggiamente il tuo cammino per salvare il regno.</p>
    <button id="start-btn" aria-label="Inizia il gioco">Inizia il gioco</button>`;
    fadeOutIn(summary);
    setTimeout(() => {
      document.getElementById('start-btn').addEventListener('click', () => {
        sections[1].onEnter();
        renderSection(1);
      });
    }, 500);
  }

  // Render a section by number
  function renderSection(sectionNumber) {
    // If sectionNumber is string for end states, handle separately
    if (sectionNumber === 'end-success') {
      renderEnd(true);
      return;
    }
    if (sectionNumber === 'end-failure') {
      renderEnd(false);
      return;
    }

    // If we are following plan, enforce plan sequence
    if (planStepIndex >= 0) {
      // If next section is not the expected one, force next in plan
      if (sectionNumber !== planSequence[planStepIndex]) {
        sectionNumber = planSequence[planStepIndex];
      }
    }

    const section = sections[sectionNumber];
    if (!section) {
      // Unknown section fallback
      renderEnd(false);
      return;
    }

    // Update path steps count
    state.pathSteps++;

    // Call onEnter to update state
    if (typeof section.onEnter === 'function') {
      section.onEnter();
    }

    // Build HTML content
    let html = `<h2>Sezione ${sectionNumber}</h2>${section.narrative}<div id="choices" role="list">`;

    // Filter choices by condition if any
    let availableChoices = section.choices.filter(choice => {
      if (!choice.condition) return true;
      return choice.condition(state);
    });

    // If we are following plan, only show the choice that leads to next plan step
    if (planStepIndex >= -1 && planStepIndex < planSequence.length -1) {
      // Next plan section
      const nextPlanSection = planSequence[planStepIndex+1];
      availableChoices = availableChoices.filter(c => c.next === nextPlanSection);
      // If none matches, fallback to all choices
      if (availableChoices.length === 0) {
        availableChoices = section.choices;
      }
    }

    // If no choices (end state), show no buttons
    if (availableChoices.length === 0) {
      html += `<p><em>Fine della sezione.</em></p>`;
    } else {
      for (const choice of availableChoices) {
        html += `<button role="listitem" class="choice-btn" data-next="${choice.next}" aria-label="Scegli: ${choice.text}">${choice.text}</button>`;
      }
    }
    html += `</div>`;

    fadeOutIn(html);

    // After fade in, add event listeners to buttons
    setTimeout(() => {
      const buttons = container.querySelectorAll('.choice-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const next = btn.getAttribute('data-next');
          // If following plan, increment planStepIndex if next matches plan
          if (planStepIndex < planSequence.length -1 && parseInt(next) === planSequence[planStepIndex+1]) {
            planStepIndex++;
          }
          renderSection(isNaN(next) ? next : parseInt(next));
        });
      });
    }, 500);
  }

  // Render end screen: success or failure
  function renderEnd(success) {
    let title = success ? "Vittoria!" : "Sconfitta";
    let message = success ?
      `<p>Hai salvato Eldoria riportando la luce e la speranza al regno. Grazie al tuo coraggio e alla tua determinazione, il Cristallo di Luce è tornato al suo posto e il Guardiano Oscuro è stato sconfitto.</p>` :
      `<p>La tua missione è fallita. Senza la chiave magica o dopo la sconfitta, le tenebre hanno avvolto Eldoria. Il destino del regno resta incerto e le ombre si fanno più profonde.</p>`;

    const html = `<h2>${title}</h2>${message}
    <button id="play-again-btn" aria-label="Gioca di nuovo">Gioca di nuovo</button>`;

    fadeOutIn(html);

    setTimeout(() => {
      document.getElementById('play-again-btn').addEventListener('click', () => {
        renderStartPage();
      });
    }, 500);
  }

  // Initialize game on load
  window.addEventListener('load', () => {
    renderStartPage();
  });
})();
</script>
</body>
</html>